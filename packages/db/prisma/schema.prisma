generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  role      Role     @default(USER)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  accounts  Account[]
  sessions  Session[]
}

enum Role {
  USER
  EDITOR
  ADMIN
}

model Asset {
  id            String         @id @default(cuid())
  slug          String         @unique
  type          AssetType
  sourceUrl     String?
  status        AssetStatus    @default(DRAFT)
  language      String         @default("he")
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  categoryLinks AssetCategory[]
  contents      AssetContent[]
  media         Media[]
  keywords      AssetKeyword[]
  events        EventLog[]
}

enum AssetType {
  PRODUCT
  REAL_ESTATE
  ARTICLE
  GENERIC
}

enum AssetStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

model Category {
  id             String         @id @default(cuid())
  slug           String         @unique
  name           String
  parentId       String?
  parent         Category?      @relation("CategoryToCategory", fields: [parentId], references: [id])
  children       Category[]     @relation("CategoryToCategory")
  depth          Int            @default(0)
  path           String
  primaryKeyword String?
  language       String         @default("he")
  status         CategoryStatus @default(ACTIVE)
  topicClusters  TopicCluster[]
  assets         AssetCategory[]
}

enum CategoryStatus {
  ACTIVE
  HIDDEN
  DEPRECATED
}

model TopicCluster {
  id            String        @id @default(cuid())
  slug          String        @unique
  name          String
  categoryId    String
  category      Category      @relation(fields: [categoryId], references: [id])
  pillarAssetId String?
  pillarAsset   Asset?        @relation(fields: [pillarAssetId], references: [id])
  primaryIntent SearchIntent  @default(INFORMATIONAL)
  maxAssets     Int           @default(50)
  autoLinkRules Json?
  members       ClusterMember[]
}

model ClusterMember {
  id        String       @id @default(cuid())
  clusterId String
  cluster   TopicCluster @relation(fields: [clusterId], references: [id])
  assetId   String
  asset     Asset        @relation(fields: [assetId], references: [id])

  @@unique([assetId, clusterId])
}

enum SearchIntent {
  INFORMATIONAL
  TRANSACTIONAL
  NAVIGATIONAL
  COMMERCIAL
}

model AssetCategory {
  id         String   @id @default(cuid())
  assetId    String
  asset      Asset    @relation(fields: [assetId], references: [id])
  categoryId String
  category   Category @relation(fields: [categoryId], references: [id])

  @@unique([assetId, categoryId])
}

model AssetContent {
  id                String   @id @default(cuid())
  assetId           String
  asset             Asset    @relation(fields: [assetId], references: [id])
  lang              String   @default("he")
  metaTitle         String?
  metaDescription   String?
  primaryKeyword    String?
  secondaryKeywords String[]
  h1                String?
  subhead           String?
  jsonBody          Json?
  htmlBody          String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

model AssetKeyword {
  id        String       @id @default(cuid())
  assetId   String
  asset     Asset        @relation(fields: [assetId], references: [id])
  keyword   String
  language  String       @default("he")
  intent    SearchIntent @default(INFORMATIONAL)
  priority  Int          @default(2)
  isPrimary Boolean      @default(false)
}

model InternalLink {
  id            String       @id @default(cuid())
  sourceAssetId String
  targetAssetId String
  anchorText    String
  linkType      LinkType
  position      LinkPosition @default(BODY)
  weight        Float        @default(0.5)
  autoGenerated Boolean      @default(true)
}

enum LinkType {
  PILLAR
  CLUSTER
  BREADCRUMB
  RELATED
  NAV
}

enum LinkPosition {
  BODY
  SIDEBAR
  FOOTER
  HEADER
}

model Media {
  id       String  @id @default(cuid())
  assetId  String
  asset    Asset   @relation(fields: [assetId], references: [id])
  url      String
  altText  String?
  mimeType String?
  width    Int?
  height   Int?
  hash     String?
  provider String?
}

model EventLog {
  id        String   @id @default(cuid())
  assetId   String?
  eventType String
  payload   Json?
  createdAt DateTime @default(now())
}

model SEORecommendation {
  id      String   @id @default(cuid())
  assetId String
  type    String
  details Json?
  createdAt DateTime @default(now())
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expires      DateTime
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@id([identifier, token])
}
